<!doctype html>
<html lang="ja">

<head>
    <title>愛でろっ！</title>
    <meta charset="utf-8">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500&display=swap" rel="stylesheet">

    <meta name="viewport" content="width=device-width,initial-scale=1">
    <link rel="stylesheet" href="css/main.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paper.js/0.12.18/paper-full.min.js"></script>
    <script src="js/main.js" defer></script>
    <style>
        #toggle {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.7rem;
            line-height: 0rem;
            font-size: 1.1rem;
            box-sizing: border-box;
            writing-mode: vertical-rl;
            gap: 0rem;
            letter-spacing: 0rem;
        }

        #toggle input {
            width: 1rem;
            height: 1rem;
        }



        #controls {
            position: absolute;
            top: 0;
            font-size: 0.7rem;
            background-color: rgba(200, 200, 200, 0.5);
            align-items: center;
            /*pointer-events: none;*/
            padding: 1rem;
            box-sizing: border-box;
            display: none;
            flex-direction: column;
            gap: 0rem;
        }

        #controls label {
            color: #000
        }

        #controls span {
            color: #000
        }

        #controls input[type="range"] {
            width: 10rem;
        }

        footer {
            position: absolute;
            bottom: 0;
            left: 0;
            padding: 1rem;
            font-size: 1rem;
            box-sizing: border-box;
        }
    </style>
</head>

<body>



    <button id="btn">傾き取得 開始</button>
    <div>
        <label id="toggle"><input type="checkbox" id="debug">&nbsp;デバッグ</label>
    </div>

    <div id="controls">
        <label>RX: <span id="xv">0</span> <br> <input type="range" id="rx" min="-1" max="1" step="any"
                value="0"></label>

        <label>RY: <span id="yv">0</span> <br> <input type="range" id="ry" min="-1" max="1" step="any"
                value="0"></label>

        <label>RZ: <span id="zv">0</span> <br> <input type="range" id="rz" min="-1" max="1" step="any"
                value="0"></label>

        <label>RK: <span id="kv">0</span> <br> <input type="range" id="rk" min="-1" max="1" step="any"
                value="0"></label>

        <label>RK2: <span id="kv2">0</span> <br> <input type="range" id="rk2" min="-1" max="1" step="any"
                value="0"></label>

        <label>EM: <span id="ev">0</span> <br> <input type="range" id="ek" min="0" max="1" step="any" value="0"></label>
    </div>

    <canvas id="myCanvas" resize></canvas>

    <footer>
        <div>© 2025 / fuyune uruno</div>
    </footer>


    <script>
        const xs = document.querySelector("#rx");
        const xv = document.querySelector("#xv");

        const ys = document.querySelector("#ry");
        const yv = document.querySelector("#yv");

        const zs = document.querySelector("#rz");
        const zv = document.querySelector("#zv");

        const ks = document.querySelector("#rk");
        const kv = document.querySelector("#kv");

        const ks2 = document.querySelector("#rk2");
        const kv2 = document.querySelector("#kv2");

        const es = document.querySelector("#ek");
        const ev = document.querySelector("#ev");

        const toggle = document.querySelector("#debug");
        const controls = document.querySelector("#controls");

        const btn = document.querySelector("#btn");

        let alpha = 0;
        let beta = 0;
        let gamma = 0;


        const canvas = document.getElementById("myCanvas");
        const rect = canvas.getBoundingClientRect();

        const gp = navigator.getGamepads();
        const smoothFactor = 0.1;

        let gamepad = null;

        //let x = 0, y = 0, z = 0;
        const faceRotatein = { x: 0, y: 0, z: 0 };

        let Rk = 0, Rk2 = 0, emi = 0;
        let pushA = false;
        let ontouch = false;
        let touchmode = true;

        let startX = 0, moveX = 0, flickX = 0;
        let startY = 0, moveY = 0, flickY = 0;





        function smooth(current, target, factor) {
            return current + (target - current) * factor;
        }



        toggle.addEventListener('change', () => {
            controls.style.display = toggle.checked ? "flex" : "none";
            touchmode = toggle.checked ? false : true;
            console.log(toggle.checked ? "checked" : "unchecked");
        })




        canvas.addEventListener('touchstart', e => {
            if (touchmode) {
                e.preventDefault();
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                ontouch = true;
                console.log("touch");
            }
        })

        canvas.addEventListener('touchmove', e => {
            if (touchmode) {
                moveX = e.touches[0].clientX;
                moveY = e.touches[0].clientY;
                flickX = moveX - startX;
                flickY = moveY - startY;
                faceRotatein.y = flickX / rect.width * 1.5;
                faceRotatein.x = -flickY / rect.height * 1.5;
                //xv.textContent = flickY;
                //yv.textContent = flickX;
                console.log(moveX, moveY);
            }
        })

        canvas.addEventListener('touchend', e => {
            if (touchmode) {
                ontouch = false;
                console.log("touchend");
            }
        })



        btn.onclick = async () => {
            // 未対応環境の除外
            if (typeof DeviceOrientationEvent === "undefined") return;

            // iOS用の許可
            if (typeof DeviceOrientationEvent.requestPermission === "function") {
                const p = await DeviceOrientationEvent.requestPermission();
                if (p !== "granted") return;
            }

            // 傾き取得 → 変数に代入
            window.addEventListener("deviceorientation", e => {
                gamma = e.gamma; 
                beta = e.beta;
                alpha = e.alpha;
                zv.textContent = gamma;
                faceRotatein.z = gamma/90;
            });
        };



        function loop() {
            const gamepads = navigator.getGamepads();
            gamepad = gamepads[0];


            if (touchmode) {
                if (ontouch) {

                    emi = smooth(emi, 1, 0.5);

                }
                else {
                    emi = smooth(emi, 0, 0.7);
                    faceRotatein.y = smooth(faceRotatein.y, 0, 0.3);
                    faceRotatein.x = smooth(faceRotatein.x, 0, 0.3);
                }
            }


            //faceRotatein.z = gamma / 90;


            if (gamepad) {
                faceRotatein.y = smooth(faceRotatein.y, gamepad.axes[0], smoothFactor);
                faceRotatein.x = smooth(faceRotatein.x, -gamepad.axes[1], smoothFactor);
                Rk = smooth(Rk, gamepad.axes[2], smoothFactor * 2);
                Rk2 = smooth(Rk2, -gamepad.axes[3], smoothFactor * 2);
                pushA = gamepad.buttons[0].pressed;
                xv.textContent = gamepad.axes[1].toFixed(5);
                yv.textContent = gamepad.axes[0].toFixed(5);
                kv.textContent = gamepad.axes[2].toFixed(5);
                kv2.textContent = gamepad.axes[3].toFixed(5);
            }

            //console.log(faceRotatein.x, faceRotatein.y);

            requestAnimationFrame(loop);
        }
        loop();



        xs.addEventListener("input", () => {
            xv.textContent = xs.value;
            faceRotatein.x = parseFloat(xs.value);
            console.log(faceRotatein.x);
        })

        ys.addEventListener("input", () => {
            yv.textContent = ys.value;
            faceRotatein.y = parseFloat(ys.value);
            console.log(faceRotatein.y)
        })

        zs.addEventListener("input", () => {
            zv.textContent = zs.value;
            faceRotatein.z = parseFloat(zs.value);
            console.log(faceRotatein.z)
            //console.log(Math.atan2(faceRotate.x, faceRotate.y));
            //console.log(Math.sqrt(faceRotate.y * faceRotate.y + faceRotate.x * faceRotate.x));

        })

        ks.addEventListener("input", () => {
            kv.textContent = ks.value;
            Rk = parseFloat(ks.value);
            //console.log(faceRotate.y)
        })

        ks2.addEventListener("input", () => {
            kv2.textContent = ks2.value;
            Rk2 = parseFloat(ks2.value);
            //console.log(faceRotate.y)
        })

        es.addEventListener("input", () => {
            ev.textContent = es.value;
            emi = parseFloat(es.value);
            //console.log(faceRotate.y)
        })

    </script>

</body>

</html>